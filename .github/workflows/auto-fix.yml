name: "Auto Fix (CI failure)"

on:
  # KÃ­ch hoáº¡t khi workflow CI hoÃ n táº¥t (pass/fail). Äá»•i "CI" náº¿u tÃªn workflow CI cá»§a báº¡n khÃ¡c.
  workflow_run:
    workflows: ["ci"]
    types: [completed]

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: auto-fix-${{ github.event.workflow_run.id }}
  cancel-in-progress: false

jobs:
  autofix:
    # Chá»‰ cháº¡y náº¿u káº¿t luáº­n CI lÃ  failure vÃ  cÃ³ Ã­t nháº¥t 1 PR liÃªn quan
    if: >
      ${{ github.event.workflow_run.conclusion == 'failure' &&
          github.event.workflow_run.event == 'pull_request' &&
          github.event.workflow_run.pull_requests &&
          github.event.workflow_run.pull_requests[0].number }}
    runs-on: ubuntu-latest

    env:
      RUN_ID: ${{ github.event.workflow_run.id }}
      PR_NUMBER: ${{ github.event.workflow_run.pull_requests[0].number }}
      HEAD_BRANCH: ${{ github.event.workflow_run.pull_requests[0].head.ref }}
      MAX_ATTEMPTS: "3"   # Giá»›i háº¡n sá»‘ láº§n tá»± sá»­a liÃªn tiáº¿p
      CODEX_PROMPT_PREFIX: |
        Nhiá»‡m vá»¥: dá»±a trÃªn log CI dÆ°á»›i Ä‘Ã¢y, tÃ¬m lá»—i chÃ­nh vÃ  táº¡o patch DIFF chuáº©n `git` Ä‘á»ƒ sá»­a tá»‘i thiá»ƒu cho build/test pass.
        YÃŠU Cáº¦U:
        - Chá»‰ xuáº¥t DIFF (dáº¡ng unified diff vá»›i `--- a/` vÃ  `+++ b/`), KHÃ”NG giáº£i thÃ­ch.
        - KhÃ´ng Ä‘á»•i logic khÃ´ng liÃªn quan.
        - Náº¿u khÃ´ng cháº¯c cháº¯n, thÃªm fix nhá» (import thiáº¿u, type sai, Ä‘Æ°á»ng dáº«n sai, test cáº­p nháº­t nhá») Ä‘á»ƒ build/test qua.
      # Tuá»³ chá»n: Ä‘áº·t CODEX_API_KEY / CODEX_API_URL lÃ m secrets náº¿u báº¡n dÃ¹ng service riÃªng
      CODEX_API_KEY: ${{ secrets.CODEX_API_KEY }}
      CODEX_API_URL: ${{ secrets.CODEX_API_URL }}

    steps:
      - name: Show context
        run: |
          echo "RUN_ID=${RUN_ID}"
          echo "PR_NUMBER=${PR_NUMBER}"
          echo "HEAD_BRANCH=${HEAD_BRANCH}"

      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ env.HEAD_BRANCH }}
          fetch-depth: 0

      - name: Ensure Git identity for commits
        run: |
          git config user.name "autofix-bot"
          git config user.email "bot@diabot.top"

      - name: Install gh CLI (if missing)
        run: |
          if ! command -v gh >/dev/null 2>&1; then
            sudo apt-get update -y
            sudo apt-get install -y gh
          fi
          gh --version

      - name: Fetch CI logs for failed run
        id: logs
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Ghi log CI cá»§a workflow_run id vá» file
          gh run view "${RUN_ID}" --log > ci.log || true
          echo "----[ tail 120 lines ]----"
          tail -n 120 ci.log || true
          # LÆ°u Ä‘oáº¡n log sÃºc tÃ­ch Ä‘á»ƒ feed cho Codex
          tail -n 500 ci.log > ci_tail.log || true
          echo "::set-output name=log_ready::$( [ -s ci_tail.log ] && echo yes || echo no )"

      - name: Abort if no logs available
        if: steps.logs.outputs.log_ready != 'yes'
        run: |
          echo "KhÃ´ng láº¥y Ä‘Æ°á»£c log CI. Dá»«ng auto-fix."
          exit 1

      # (Tuá»³ báº¡n) Náº¿u cáº§n Node Ä‘á»ƒ cháº¡y npx codex
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Generate patch with Codex (preferred)
        id: genpatch
        run: |
          # Æ¯U TIÃŠN: dÃ¹ng npx gá»i cÃ´ng cá»¥ codex-cli ná»™i bá»™ (náº¿u cÃ³)
          # YÃªu cáº§u: package codex-cli tÆ°Æ¡ng thÃ­ch npx (hoáº·c báº¡n thay báº±ng lá»‡nh riÃªng)
          set -e
          echo "=== Prompt start ==="
          echo "${CODEX_PROMPT_PREFIX}"
          echo "===== LOG ====="
          tail -n 500 ci.log | sed 's/\x1b\[[0-9;]*m//g' | tail -n 500
          echo "=== Prompt end ==="

          # Thá»­ dÃ¹ng npx (sáº½ tá»± táº£i náº¿u chÆ°a cÃ³). Äá»•i lá»‡nh cho khá»›p CLI cá»§a báº¡n.
          # VÃ­ dá»¥ minh hoáº¡: npx @diabot/codex-cli diff --stdin-log > patch.diff
          if npx -y @diabot/codex-cli@latest diff --prompt "${CODEX_PROMPT_PREFIX}" --log-file ./ci_tail.log > patch.diff 2> codex.err; then
            echo "Codex CLI generated patch."
          else
            echo "Codex CLI failed or not available. Falling back to generic endpoint if provided."
            # Fallback: gá»i endpoint CODEX_API_URL (náº¿u báº¡n cÃ³ DIA BRAIN/OpenAI proxy).
            if [ -n "${CODEX_API_URL}" ] && [ -n "${CODEX_API_KEY}" ]; then
              curl -sS -X POST "${CODEX_API_URL}" \
                -H "Authorization: Bearer ${CODEX_API_KEY}" \
                -H "Content-Type: application/json" \
                -d "$(jq -n --arg prompt "${CODEX_PROMPT_PREFIX}" --rawfile log ./ci_tail.log '{prompt:$prompt,log:$log,mode:"diff"}')" \
                > patch.diff || true
            fi
          fi

          # Kiá»ƒm tra patch
          if [ ! -s patch.diff ]; then
            echo "NO_PATCH=1" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Heuristic: patch há»£p lá»‡ thÆ°á»ng cÃ³ --- a/ vÃ  +++ b/
          if ! grep -qE '^--- a/|^\+\+\+ b/' patch.diff; then
            echo "Patch khÃ´ng cÃ³ header unified diff há»£p lá»‡. XoÃ¡ patch."
            rm -f patch.diff
            echo "NO_PATCH=1" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "NO_PATCH=0" >> $GITHUB_OUTPUT

      - name: Stop if no patch generated
        if: steps.genpatch.outputs.NO_PATCH == '1'
        run: |
          echo "Codex khÃ´ng táº¡o Ä‘Æ°á»£c patch há»£p lá»‡. Dá»«ng lÆ°á»£t auto-fix nÃ y."
          exit 1

      - name: Apply patch
        id: apply
        run: |
          set -e
          git apply --index --reject patch.diff || {
            echo "apply_fail=1" >> $GITHUB_OUTPUT
            exit 1
          }
          echo "apply_fail=0" >> $GITHUB_OUTPUT

      - name: Commit & push fix
        if: steps.apply.outputs.apply_fail == '0'
        run: |
          # Äáº¿m sá»‘ láº§n autofix trÆ°á»›c Ä‘Ã³ Ä‘á»ƒ giá»›i háº¡n vÃ²ng láº·p
          COUNT=$(git log --oneline | grep -c '^.*autofix: CI failure patch')
          echo "Autofix attempt so far: $COUNT"
          if [ "$COUNT" -ge "$MAX_ATTEMPTS" ]; then
            echo "VÆ°á»£t quÃ¡ MAX_ATTEMPTS=${MAX_ATTEMPTS}. Dá»«ng."
            exit 1
          fi

          git commit -m "autofix: CI failure patch (attempt $((COUNT+1)))" || true
          # Náº¿u khÃ´ng cÃ³ gÃ¬ Ä‘á»ƒ commit (do patch trÃ¹ng), dá»«ng sá»›m Ä‘á»ƒ trÃ¡nh vÃ²ng láº·p
          if ! git diff --exit-code; then
            echo "There are staged changes after commit (?)"
          fi
          # Push lÃªn Ä‘Ãºng nhÃ¡nh PR
          git push origin HEAD:${HEAD_BRANCH}

      - name: Comment back to PR
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = Number(process.env.PR_NUMBER);
            const { owner, repo } = context.repo;
            const body = [
              "ğŸ¤– **Auto-Fix Bot**: Ä‘Ã£ táº¡o patch vÃ  push lÃªn nhÃ¡nh PR.",
              "- CI Ä‘ang cháº¡y láº¡i. Náº¿u cÃ²n fail, bot sáº½ tiáº¿p tá»¥c thá»­ (tá»‘i Ä‘a " + process.env.MAX_ATTEMPTS + " láº§n).",
              "- Báº¡n cÃ³ thá»ƒ dá»«ng bot báº±ng cÃ¡ch gá»¡ quyá»n hoáº·c Ä‘á»•i nhÃ£n."
            ].join("\n");
            await github.rest.issues.createComment({ owner, repo, issue_number: prNumber, body });

      - name: Stop if attempts exceeded (soft guard)
        run: |
          # Náº¿u commit khÃ´ng táº¡o thay Ä‘á»•i, step trÆ°á»›c Ä‘Ã£ exit 0; CI sáº½ rerun.
          # Guard bá»• sung: khÃ´ng lÃ m gÃ¬, vÃ¬ CI sáº½ tá»± cháº¡y láº¡i trÃªn push má»›i.
          echo "Auto-fix step completed."
