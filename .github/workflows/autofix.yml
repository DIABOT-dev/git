name: Autofix #auth (full setup)

on:
  workflow_dispatch:
    inputs:
      simulate_result:
        description: "PASS or FAIL for #auth test simulation"
        required: true
        default: "PASS"

jobs:
  autofix-auth:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Run #auth simulation
        id: simulate
        run: |
          echo "🧠 Running #auth simulation..."
          echo "Result: ${{ inputs.simulate_result }}"
          if [ "${{ inputs.simulate_result }}" = "FAIL" ]; then
            echo "result=fail" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "result=pass" >> $GITHUB_OUTPUT
          fi

      - name: Handle FAIL → create branch & PR
        if: failure()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "❌ Test failed — creating autofix branch..."
          BRANCH="autofix-auth-$(date +%s)"
          git config user.name "github-actions"
          git config user.email "bot@users.noreply.github.com"
          git checkout -b $BRANCH
          echo "Autofix log for #auth" > AUTOFIX_LOG.txt
          git add AUTOFIX_LOG.txt
          git commit -m "chore(autofix): add log for #auth failure"
          git push origin $BRANCH
          gh pr create --base main --head $BRANCH \
            --title "Autofix #auth: simulated fix" \
            --body "Auto-created branch \`$BRANCH\` after #auth simulation failed."

      - name: Handle PASS → summary
        if: success()
        run: |
          echo "✅ Simulation PASS — no autofix required."
          echo "All tests OK. Ready for Codex or manual QA."
