name: Deploy Camp

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    env:
      SSH_KEY: ${{ secrets.VPS_SSH_KEY }}
      VPS_HOST: ${{ secrets.VPS_HOST }}
      VPS_USER: ${{ secrets.VPS_USER }}
      CAMP_PATH: /home/deploy/diabot_camp
      IMAGE: ghcr.io/<org>/<repo>:${{ github.sha }}
      DIABOT_URL: https://camp.diabot.top

    steps:
      - uses: actions/checkout@v4

      # 1) Copy image name & trigger deploy qua SSH
      - name: Deploy to Camp Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ env.VPS_HOST }}
          username: ${{ env.VPS_USER }}
          key: ${{ env.SSH_KEY }}
          script: |
            cd $CAMP_PATH
            docker login ghcr.io -u $GITHUB_ACTOR -p ${{ secrets.GITHUB_TOKEN }}
            docker compose pull && docker compose up -d
            sleep 10
            curl -fsSL ${DIABOT_URL}/api/qa/selftest || exit 1

      # 2) Smoke test & log kết quả
      - name: Smoke test APIs
        run: |
          echo "Testing endpoints..."
          curl -s -o /dev/null -w "%{http_code}" ${DIABOT_URL}/api/qa/selftest
          curl -s -o /dev/null -w "%{http_code}" ${DIABOT_URL}/api/chart/7d
          curl -s -o /dev/null -w "%{http_code}" ${DIABOT_URL}/api/profile
        continue-on-error: true
