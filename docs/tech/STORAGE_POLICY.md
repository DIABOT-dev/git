# Viettel Storage Policy

## Purpose
This policy standardizes how DIABOT services interact with Viettel Object Storage and auxiliary backups after the Bolt/Supabase sunset.

## Storage Access Model
- **Single entry point:** All upload and download operations MUST be performed through DIA BRAIN backend services. Frontend or mobile clients are prohibited from direct Viettel Object Storage calls.
- **Credential management:** Credentials remain in secure infrastructure vaults or deployment secrets; never checked into git. `.env.local.example` may only document placeholder variable names without secrets.
- **Service accounts:** Backend workers use scoped IAM users with minimum required permissions (`s3:PutObject`, `s3:GetObject`, `s3:DeleteObject`, `s3:ListBucket`). Auditable logs must be retained per Viettel compliance requirements.

## Data Flow Requirements
1. Client → DIA BRAIN API → Viettel S3. No alternate routes are allowed.
2. Public assets should be served via signed URLs generated by DIA BRAIN; configure expiration ≤ 24h (TODO: issue signed download/upload URLs in `viettel_client.ts`).
3. For large files, use pre-signed upload URLs issued by DIA BRAIN with one-time use.

## Path Conventions
Re-use the normalized folder layout established in `DEPLOYMENT_VIETTEL_STORAGE.md` and mirrored by `src/infrastructure/storage/viettel_client.ts` helper utilities:
- `meal/{user_id}/{yyyy}/{mm}/{dd}/{uuid}.{ext}`
- `avatars/{user_id}.{ext}`
- `reports/{user_id}/{report_type}_{period_end}.pdf`

Any new asset class must be added to this document before implementation.

## Backup & Retention Standards
- **Database:** Run automated daily logical backups via DIA BRAIN tooling. Retain the latest 30 snapshots in Viettel S3 under `backups/db/daily/`.
- **System configuration:** Export infrastructure & feature flag configuration weekly. Keep rolling four-week history in `backups/sysconfig/weekly/`.
- **Integrity checks:** Validate backup readability every Monday; document results in the runbook.

## Operational Guardrails
- Enforce server-side encryption (SSE-S3) for all objects.
- Enable versioning on production buckets to mitigate accidental overwrites.
- Block all public bucket ACLs; rely on signed URL delivery.
- Monitor storage usage and failed operations via Viettel Cloud metrics dashboard.

## Compliance & Audit
- Keep change logs of storage-related infrastructure updates within `docs/tech`.
- Ensure incident response playbooks include storage breach handling aligned with Viettel obligations.
- Annual review of this policy is mandatory or after any major architecture change.
