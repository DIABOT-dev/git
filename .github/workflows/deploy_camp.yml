name: Deploy Camp

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    env:
      SSH_KEY: ${{ secrets.VPS_SSH_KEY }}
      VPS_HOST: ${{ secrets.VPS_HOST }}
      VPS_USER: ${{ secrets.VPS_USER }}
      CAMP_PATH: /home/deploy/diabot_camp
      IMAGE: ghcr.io/DIABOT-dev/git:${{ github.sha }}
      DIABOT_URL: https://diabot.top

    steps:
      - uses: actions/checkout@v4

      # 1) Copy image name & trigger deploy qua SSH
      - name: Deploy to Camp Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ env.VPS_HOST }}
          username: ${{ env.VPS_USER }}
          key: ${{ env.VPS_SSH_KEY }}
          script: |
             set -e
             cd /home/ubuntu/diabot_camp

             echo "üì¶ Pull latest image and restart..."
             docker compose pull || true
             docker compose up -d || true

             echo "‚è≥ Waiting for container to stabilize..."
             sleep 10

             echo "ü©∫ Running health check..."
             curl -fsSL https://camp.diabot.top/api/qa/selftest || (echo "‚ùå Health check failed" && exit 1)

             echo "‚úÖ Deploy success!"

      # 2) Smoke test & log k·∫øt qu·∫£
      - name: Smoke test APIs
        run: |
          echo "Testing endpoints..."
          curl -s -o /dev/null -w "%{http_code}" ${DIABOT_URL}/api/qa/selftest
          curl -s -o /dev/null -w "%{http_code}" ${DIABOT_URL}/api/chart/7d
          curl -s -o /dev/null -w "%{http_code}" ${DIABOT_URL}/api/profile
        continue-on-error: true
