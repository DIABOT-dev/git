name: Deploy Camp

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    env:
      VPS_HOST: ${{ secrets.VPS_HOST }}
      VPS_USER: ${{ secrets.VPS_USER }}            # nÃªn lÃ  'ubuntu'
      VPS_SSH_KEY: ${{ secrets.VPS_SSH_KEY }}      # Ä‘Ãºng tÃªn secret
      CAMP_PATH: /home/ubuntu/diabot_camp          # Ä‘Ãºng Ä‘Æ°á»ng dáº«n theo user
      DIABOT_URL: https://camp.diabot.top
      # IMAGE: ghcr.io/DIABOT-dev/git:${{ github.sha }}  # náº¿u cáº§n dÃ¹ng thÃ¬ tham chiáº¿u trong compose

    steps:
      - uses: actions/checkout@v4

      - name: Deploy to Camp Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ env.VPS_HOST }}
          username: ${{ env.VPS_USER }}
          key: ${{ env.VPS_SSH_KEY }}
          script: |
            set -e
            echo "ðŸš€ Starting Deploy Camp"

            # Ensure workdir exists
            if [ ! -d "${CAMP_PATH}" ]; then
              mkdir -p "${CAMP_PATH}"
            fi
            cd "${CAMP_PATH}"

            # Ensure compose file exists (chá»‰nh tÃªn náº¿u báº¡n dÃ¹ng file khÃ¡c)
            if [ ! -f docker-compose.yml ]; then
              echo "âŒ Missing docker-compose.yml at ${CAMP_PATH}"
              exit 1
            fi

            echo "ðŸ“¦ Pulling latest images..."
            docker compose pull || true

            echo "ðŸ” Restarting services..."
            docker compose up -d || true

            echo "â³ Waiting for services to start..."
            sleep 10

            echo "ðŸ©º Health check (domain)..."
            if ! curl -fsSL https://camp.diabot.top/api/qa/selftest >/dev/null; then
              echo "âš ï¸ Domain check failed, trying IP fallback..."
              curl -fsSL http://$HOSTNAME:3000/api/qa/selftest >/dev/null || exit 1
            fi

            echo "âœ… Deploy Camp completed successfully!"

      - name: Smoke test APIs (external)
        run: |
          set -e
          echo "Testing endpoints at ${DIABOT_URL} ..."
          curl -s -o /dev/null -w "selftest=%{http_code}\n" ${DIABOT_URL}/api/qa/selftest
          curl -s -o /dev/null -w "chart7d=%{http_code}\n" ${DIABOT_URL}/api/chart/7d || true
          curl -s -o /dev/null -w "profile=%{http_code}\n" ${DIABOT_URL}/api/profile || true
